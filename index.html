<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Discussion Forum</title>
<style>
  body { margin:0; font-family: Arial, sans-serif; background:#f5f7fa; }

  /* Login/Signup Overlay */
  #login-overlay {
    position: fixed; top:0; left:0; width:100%; height:100%;
    background: rgba(0,0,0,0.5); display:flex; justify-content:center; align-items:center;
    z-index: 9999;
  }
  #login-box {
    background:white; padding:30px; border-radius:12px; width:300px; text-align:center;
  }
  #login-box input { width:100%; padding:10px; margin:10px 0; border-radius:8px; border:1px solid #ccc; }
  #login-box button { width:100%; padding:10px; border-radius:8px; border:none; background-color:#1e3a8a; color:white; cursor:pointer; }
  #login-box button:hover { background-color:#334155; }
  #toggle-login { color:#1e3a8a; cursor:pointer; margin-top:10px; display:block; }

  /* Forum Styles */
  header {
    background-color:#1e3a8a; color:white; padding:15px; font-size:20px;
    text-align:center; position:fixed; top:0; width:100%; z-index:100;
  }
  #logout-btn {
    float:right; background:#f87171; color:white; border:none;
    border-radius:8px; padding:5px 10px; cursor:pointer;
  }
  #logout-btn:hover { background:#dc2626; }

  /* Messages container with background and frosted-glass overlay */
  .messages {
    margin-top:60px;
    margin-bottom:120px;
    padding:10px;
    display:flex;
    flex-direction:column;
    overflow-y:auto;
    height:calc(100vh - 140px);
    position: relative;

    background-image: url('https://i.imgur.com/5qfE36Z.jpg'); 
    background-size: cover;
    background-position: center;
    background-repeat: no-repeat;
  }
  .messages::before {
    content: '';
    position: absolute;
    top:0; left:0; width:100%; height:100%;
    backdrop-filter: blur(8px);
    background: rgba(255,255,255,0.2);
    z-index:0;
  }

  .message {
    background: rgba(255,255,255,0.8);
    padding:10px 15px; border-radius:12px; margin:5px 0;
    max-width:70%; word-wrap:break-word;
    box-shadow:0 1px 3px rgba(0,0,0,0.1);
    position:relative; z-index:1;
  }
  .message.user { align-self:flex-end; background-color: var(--user-color, #cce4ff); }
  .message.other { align-self:flex-start; background-color: var(--user-color, #e2e8f0); }
  .sender { font-weight:bold; cursor:pointer; margin-bottom:4px; }
  .time { font-size:10px; color:#555; margin-top:4px; }
  .replies { margin-left:20px; margin-top:5px; }
  .reply { background:#f1f5f9; margin-top:5px; padding:5px 10px; border-radius:10px; font-size:14px; position:relative; }
  .reply .sender { font-weight:bold; cursor:pointer; display:inline-block; }
  .reply-btn { font-size:12px; color:#1e3a8a; background:none; border:none; cursor:pointer; margin-left:10px; }

  .new-post { position:fixed; bottom:0; width:100%; background:#fff; display:flex; flex-direction:column; padding:10px; box-shadow:0 -2px 5px rgba(0,0,0,0.2); }
  .new-post input { flex:1; padding:10px; border-radius:20px; border:1px solid #ccc; outline:none; font-family: monospace; caret-color:#1e3a8a; }
  .new-post button { margin-top:5px; background-color:#1e3a8a; color:white; border:none; border-radius:20px; padding:10px 15px; cursor:pointer; align-self:flex-end; }
  .new-post button:hover { background-color:#334155; }

  /* Blinking cursor effect */
  .new-post input.blink::after {
    content: '|';
    animation: blink 1s step-end infinite;
  }
  @keyframes blink {
    0%, 50%, 100% { opacity: 1; }
    25%, 75% { opacity: 0; }
  }

  /* WhatsApp Floating Icon with Pulse */
  #whatsapp-icon {
    position: fixed; top: 80px; right: 20px; width: 60px; height: 60px; z-index: 10000; cursor: pointer;
    border-radius: 50%; box-shadow: 0 2px 10px rgba(0,0,0,0.3); animation: pulse 2s infinite;
  }
  #whatsapp-icon:hover { transform: scale(1.1); }
  #whatsapp-icon img { width:100%; height:100%; border-radius:50%; }
  @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.1); } 100% { transform: scale(1); } }
</style>
</head>
<body>

<!-- Login Overlay -->
<div id="login-overlay">
  <div id="login-box">
    <h2 id="login-title">Login</h2>
    <input type="email" id="login-email" placeholder="Email">
    <input type="password" id="login-password" placeholder="Password">
    <button id="login-btn">Login</button>
    <span id="toggle-login">Don't have an account? Sign Up</span>
  </div>
</div>

<header>
  Discussion Forum
  <button id="logout-btn">Logout</button>
</header>

<div class="messages" id="messages"></div>

<div class="new-post">
  <input type="text" id="message-input" class="blink" placeholder="Write a new post...">
  <button onclick="sendMessage()">Send</button>
</div>

<!-- WhatsApp Floating Icon -->
<a href="https://wa.me/260768037965" target="_blank" id="whatsapp-icon" title="Chat on WhatsApp">
  <img src="https://upload.wikimedia.org/wikipedia/commons/6/6b/WhatsApp.svg" alt="WhatsApp" />
</a>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.16.0/firebase-app.js";
import { getFirestore, collection, addDoc, query, orderBy, onSnapshot, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.16.0/firebase-firestore.js";
import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/10.16.0/firebase-auth.js";

// --- Firebase Configuration ---
const firebaseConfig = {
  apiKey: "AIzaSyAazQb4Oz3iLOLEb7MBHuAI9BaFENdASkw",
  authDomain: "secondary-center.firebaseapp.com",
  projectId: "secondary-center",
  storageBucket: "secondary-center.firebasestorage.app",
  messagingSenderId: "1019887514683",
  appId: "1:1019887514683:web:9fa14e19c90dde1b8e181e",
  measurementId: "G-QYDF7KL20V"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);

// --- Login / Signup ---
let currentUser = null;
let currentUserJoinTime = null;
let isLogin = true;

const overlay = document.getElementById('login-overlay');
const toggleLogin = document.getElementById('toggle-login');
const loginBtn = document.getElementById('login-btn');

toggleLogin.addEventListener('click', () => {
  isLogin = !isLogin;
  document.getElementById('login-title').innerText = isLogin ? "Login" : "Sign Up";
  loginBtn.innerText = isLogin ? "Login" : "Sign Up";
  toggleLogin.innerText = isLogin ? "Don't have an account? Sign Up" : "Already have an account? Login";
});

loginBtn.addEventListener('click', async () => {
  const email = document.getElementById('login-email').value.trim();
  const password = document.getElementById('login-password').value.trim();
  if(!email || !password){ alert("Fill all fields!"); return; }

  try {
    if(isLogin){
      const userCredential = await signInWithEmailAndPassword(auth,email,password);
      currentUser = userCredential.user.email;
      currentUserJoinTime = Date.now(); // show messages after login
    } else {
      const userCredential = await createUserWithEmailAndPassword(auth,email,password);
      currentUser = userCredential.user.email;
      currentUserJoinTime = Date.now();
    }
    overlay.style.display='none';
    loadMessages();
  } catch(err){
    alert("Error: "+err.message);
  }
});

document.getElementById('logout-btn').addEventListener('click', async () => {
  await signOut(auth);
  currentUser = null;
  overlay.style.display='flex';
});

// --- Firestore Messages ---
const messagesContainer = document.getElementById('messages');
const input = document.getElementById('message-input');

function loadMessages(){
  const q = query(collection(db,"messages"), orderBy("timestamp"));
  onSnapshot(q, snapshot => {
    messagesContainer.innerHTML = "";
    snapshot.docs.forEach(docSnap => {
      const msg = docSnap.data();
      if(msg.timestamp.toMillis() < currentUserJoinTime) return; // only show after user join

      const msgDiv = document.createElement('div');
      msgDiv.className = 'message ' + (msg.sender===currentUser?"user":"other");
      msgDiv.style.setProperty('--user-color', msg.sender===currentUser?"#cce4ff":"#e2e8f0");

      const sender = document.createElement('div'); sender.className='sender'; sender.textContent = msg.sender;
      const msgText = document.createElement('div'); msgText.textContent = msg.text;
      const time = document.createElement('div'); time.className='time';
      time.textContent = new Date(msg.timestamp.toMillis()).toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'});

      msgDiv.appendChild(sender);
      msgDiv.appendChild(msgText);
      msgDiv.appendChild(time);
      messagesContainer.appendChild(msgDiv);
    });
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
  });
}

// --- Send Message ---
window.sendMessage = async function(){
  const text = input.value.trim();
  if(!text || !currentUser) return;
  await addDoc(collection(db,"messages"),{
    sender: currentUser,
    text: text,
    timestamp: serverTimestamp()
  });
  input.value='';
}
</script>
</body>
</html>